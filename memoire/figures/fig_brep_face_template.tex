\newcommand{\figbrepface}[3]{%#1 : indice de face, #2 : x ancrage, #3 :y ancrage
\DTLsetseparator{,}%
%
\DTLloaddb[noheader,keys={id,x,y,a,dx,dy}]{dbverts}{figures/data/fig_brep_faces/verts_dxy_#1.dat}%
%
\DTLloaddb[noheader,keys={id,x,y,dx,dy,a}]{dbedges}{figures/data/fig_brep_faces/edges_#1.dat}%
%
\DTLloaddb[noheader,keys={r,g,b}]{dbfacecolor}{figures/data/fig_brep_faces/facecolor_#1.dat}%
\DTLassign{dbfacecolor}{1}{\rfai=r,\gfai=g,\bfai=b}% 
\definecolor{facecolor}{RGB}{\rfai,\gfai,\bfai}
%
\DTLloaddb[noheader,keys={u,v,du,dv}]{dbwires}{figures/data/fig_brep_faces/contours_label_#1.dat}%
%
\DTLloaddb[noheader,keys={u,v,du,dv,ied,ihe,iw}]{dbcurves}{figures/data/fig_brep_faces/curve_uvdata_#1.dat}%
\pgfmathsetmacro\numberofwires{\DTLrowcount{dbwires}}%
%
\DTLloaddb[noheader,keys={u,v}]{dbfaceuvlabel}{figures/data/fig_brep_faces/face_uvlabel_#1.dat}%
%
\begin{scope}[shift={({#2},{#3})}]
	%% SURFACE & FACE
	\node[img] (face_#1) at (0,0) {\includegraphics[width=\imfacew]{figures/fig_brep_faces/face_#1}};
	%
	{\transparent{0.15}%
		\node[img] (surface_#1) at (0,0) {\includegraphics[width=\imfacew]{figures/fig_brep_faces/surface_#1}};}%
	%%% EDGES
		\node[img] at (0,0) {\includegraphics[width=\imfacew]{figures/fig_brep_faces/edges_hid_#1}};%}%
	\DTLforeach*{dbedges}{\loci=id, \locx=x, \locy=y, \locdx=dx, \locdy=dy, \loca=a}%
	{%
		\pgfmathsetmacro\iloci{int(round(\loci))}%
		\pgfmathsetmacro\scl{\edglabsepxyz/veclen(\locdx,\locdy)}
		\node[label, anchor=center] at 
		({\locx+\scl*\locdx},{\locy+\scl*\locdy}) 
		{$\brepedge_{\iloci}$};%
	}%
	%%% VERTICES
	\DTLforeach*{dbverts}{\loci=id, \locx=x, \locy=y, \loca=a, \locdx=dx, \locdy=dy}%
	{%
		\fill[black] (\locx,\locy) circle (1pt);
		\node[label, anchor=center] at 
		({\locx+\vertsep*\locdx},{\locy+\vertsep*\locdy}) 
		{$\mathrm{V}_{\mkern-2mu\loci}$};%
	}%
	{\transparent{0.65}%
		\node[img] (facetr_#1) at (0,0) {\includegraphics[width=\imfacew]{figures/fig_brep_faces/face_#1}};}%
	\node[img] at (0,0) {\includegraphics[width=\imfacew]{figures/fig_brep_faces/edges_vis_#1}};
	%%% UV-SPACE
	\begin{scope}[shift={(0.5,-0.7)}, scale={\uvscale}]
		%% UV-GRID
		\foreach \loci in {0,...,\ngriduv}
		{%
			\pgfmathsetmacro\locxi{-1 + 2*\loci/\ngriduv}%
			\draw[uvgrid] (-1,\locxi) -- ++ (2,0);
			\draw[uvgrid] (\locxi,-1) -- ++ (0,2);
		}%		
		%% FILL UV DOMAIN
		\ifnum \numberofwires > 0
			\fill[facecolor] 
				plot file {figures/data/fig_brep_faces/contour_ext_#1.dat}
				plot file {figures/data/fig_brep_faces/contour_int_#1_1.dat};
		\else
			\fill[facecolor] plot file {figures/data/fig_brep_faces/contour_ext_#1.dat};
		\fi
		%% DRAW EDGES
		\DTLforeach*{dbcurves}{\locu=u, \locv=v, \locdu=du, \locdv=dv, \locie=ied, \locih=ihe, \lociw=iw}{%
			\pgfmathsetmacro\ilocie{int(round(\locie))}%
			\pgfmathsetmacro\ilocih{int(round(\locih))}%
			\pgfmathsetmacro\ilociw{int(round(\lociw))}%
			% set wire color
			\pgfmathsetmacro\locfiw{(\iniwclr+\lociw*\decwclr)}%
			\pgfmathsetmacro\locriw{\locfiw*\rfai/255.}%
			\pgfmathsetmacro\locgiw{\locfiw*\gfai/255.}%
			\pgfmathsetmacro\locbiw{\locfiw*\bfai/255.}%
			\definecolor{clriw}{rgb}{\locriw, \locgiw, \locbiw}%
			%
			\node[label, anchor=center, clriw] at 
			({\locu + \edglabsepuv*\locdv},
			{\locv - \edglabsepuv*\locdu})
			{$\brepedge_{\ilocie}^{\ilocih}$};
			\draw[curv, 
				clriw,
				-{Triangle[left]}, 
				shorten <= 0.25pt, 
				shorten >= 0.25pt] plot file 	{figures/data/fig_brep_faces/curve_uv_#1_\DTLcurrentindex.dat};
		}%
		%% WIRE LABELS
		\DTLforeach*{dbwires}{\locu=u, \locv=v, \locdu=du, \locdv=dv}{%
			% set wire color
		 \pgfmathsetmacro\locfiw{(\iniwclr+(\DTLcurrentindex-1)*\decwclr)}%
			\pgfmathsetmacro\locriw{\locfiw*\rfai/255.}%
			\pgfmathsetmacro\locgiw{\locfiw*\gfai/255.}%
			\pgfmathsetmacro\locbiw{\locfiw*\bfai/255.}%
			\definecolor{clriw}{rgb}{\locriw, \locgiw, \locbiw}%
			\pgfmathsetmacro\locx{\locu-\wirlabsepuv*\locdv}%
			\pgfmathsetmacro\locy{\locv+\wirlabsepuv*\locdu}%
			\ifnum \DTLcurrentindex = 1%
				\node[label, anchor=center, clriw] at (\locx,\locy) {$\brepwire_{\stripzero#1}^{\mathrm{ext}}$};
			\else%
				\pgfmathsetmacro\ilociw{int(\DTLcurrentindex - 1)}
				\node[label, anchor=center, clriw] at (\locx,\locy) {$\brepwire_{\stripzero#1}^{\mathrm{int},\ilociw}$};
			\fi%
		}%
		%% FACE LABEL
		\DTLassign{dbfaceuvlabel}{1}{\locu=u,\locv=v}% 
		\node[label, anchor=center] at (\locu,\locv) {$\brepface_{\stripzero#1}$};
		%
%		\draw[blue, dashed] (-1,-1) -- (1,-1) -- (1,1) -- (-1,1) -- cycle;
%		\draw[blue, dashed] (0,-1) -- (0,1);
%		\draw[blue, dashed] (-1,0) -- (1,0);
	\end{scope}
	%
%	\draw[red, dashed] (0,0) -- (1,0) -- (1,1) -- (0,1) -- cycle;
%	\draw[red, dashed] (.5,0) -- (.5,1);
%	\draw[red, dashed] (0,.5) -- (1,.5);
%	\foreach \ii in  {0,0.1,...,1.01}{
%		\draw[red, thin] (0,\ii) -- (1,\ii)
%		                 (\ii,0) -- (\ii,1);
%	}
\end{scope}
\DTLgdeletedb{dbfaceuvlabel}
\DTLgdeletedb{dbfacecolor}
\DTLgdeletedb{dbcurves}
\DTLgdeletedb{dbwires}
\DTLgdeletedb{dbverts}
\DTLgdeletedb{dbedges}
}